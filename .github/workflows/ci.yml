name: CI Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  # nopCommerce version that matches the plugin's SupportedVersions in plugin.json
  NOPCOMMERCE_VERSION: release-4.90.3
  DOTNET_VERSION: '9.0.x'
  # Build configuration
  CONFIGURATION: Release

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout API repository
      uses: actions/checkout@v4
      with:
        path: api-for-nopcommerce

    - name: Checkout nopCommerce at ${{ env.NOPCOMMERCE_VERSION }}
      uses: actions/checkout@v4
      with:
        repository: nopSolutions/nopCommerce
        ref: ${{ env.NOPCOMMERCE_VERSION }}
        path: nopCommerce
    
    - name: Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Build required nopCommerce dependencies
      run: |
        echo "Building only required nopCommerce projects (Nop.Core and Nop.Web.Framework)..."
        dotnet build nopCommerce/src/Libraries/Nop.Core/Nop.Core.csproj --configuration ${{ env.CONFIGURATION }}
        dotnet build nopCommerce/src/Presentation/Nop.Web.Framework/Nop.Web.Framework.csproj --configuration ${{ env.CONFIGURATION }}
    
    - name: Build API plugin
      run: |
        echo "Building API plugin projects (excluding outdated ClientApp)..."
        dotnet build Nop.Plugin.Api/Nop.Plugin.Api.csproj --configuration ${{ env.CONFIGURATION }}
      working-directory: api-for-nopcommerce
    
    - name: Verify build output
      run: |
        echo "✅ Build completed successfully!"
        echo ""
        echo "Plugin output directory:"
        if [ -d "nopCommerce/src/Presentation/Nop.Web/Plugins/Nop.Plugin.Api" ]; then
          ls -lh nopCommerce/src/Presentation/Nop.Web/Plugins/Nop.Plugin.Api/
          echo ""
          echo "Plugin DLL found at expected location"
        else
          echo "⚠️ Plugin directory not found at expected location"
          exit 1
        fi
    
    - name: Extract plugin version from plugin.json
      id: plugin_version
      run: |
        VERSION=$(jq -r '.Version' nopCommerce/src/Presentation/Nop.Web/Plugins/Nop.Plugin.Api/plugin.json)
        SYSTEM_NAME=$(jq -r '.SystemName' nopCommerce/src/Presentation/Nop.Web/Plugins/Nop.Plugin.Api/plugin.json)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "system_name=$SYSTEM_NAME" >> $GITHUB_OUTPUT
        echo "Plugin Version: $VERSION"
        echo "System Name: $SYSTEM_NAME"
    
    - name: Create plugin artifact ZIP
      run: |
        PLUGIN_DIR="nopCommerce/src/Presentation/Nop.Web/Plugins/Nop.Plugin.Api"
        ARTIFACT_NAME="Plugin.${{ steps.plugin_version.outputs.system_name }}.v${{ steps.plugin_version.outputs.version }}.zip"
        
        echo "Creating plugin artifact: $ARTIFACT_NAME"
        
        # Create ZIP with plugin folder contents at root level
        cd "$PLUGIN_DIR"
        zip -r "../../../../../$ARTIFACT_NAME" . -x '*.pdb' -x '*.deps.json' -x 'ref/*' -x 'refs/*'
        cd -
        
        echo "Artifact created successfully!"
        ls -lh "$ARTIFACT_NAME"
        
        # Verify ZIP contents
        echo ""
        echo "ZIP contents:"
        unzip -l "$ARTIFACT_NAME" | head -20
    
    - name: Upload plugin artifact
      uses: actions/upload-artifact@v4
      with:
        name: Plugin.${{ steps.plugin_version.outputs.system_name }}.v${{ steps.plugin_version.outputs.version }}
        path: Plugin.${{ steps.plugin_version.outputs.system_name }}.v${{ steps.plugin_version.outputs.version }}.zip
        if-no-files-found: error
      
    # Note: Tests are commented out due to .NET Framework 4.6.1 compatibility issues
    # The test project (Nop.Plugin.Api.Tests) uses net461 which is not supported on Linux runners
    # To enable tests, the test project needs to be upgraded to .NET 6+ and project references fixed
    # - name: Run tests
    #   run: dotnet test --configuration ${{ env.CONFIGURATION }} --no-build --verbosity normal
    #   working-directory: api-for-nopcommerce
